# MIPS的单周期实现

郑逸宁 15307130115

### 项目概要

本次实验是MIPS相关实验的第一部分，因为教材《数字设计和计算机体系结构》上有MIPS单周期实现的详细介绍和大部分代码。而大部分同学都是参加教材完成的，所以我实验报告主要突出在自己做的一些工作。

### 项目实现

+ 使用System Verilog实现，源代码以.sv结尾
+ 每个模块单独一个文件更符合结构化设计的理念
+ 对模块进行参数化实现，方便以后扩展成64位
+ 实现了add，sub，and，or，slt，addi，andi，ori，slti，sw，lw，j，nop，**beq，bne** 共15个指令
+ 同时使用$display()和波形图两种方式在仿真中进行调试
+ 在Nexys4实验板上实现了：可暂停演示、七段数码显示十六进制、指令寄存器显示器切换等功能

### 项目结构

```
/images/ 	实验截图
/test/		测试所需替换的.dat文件和simulation.sv文件
/MIPS_V1.0.cache(hw,ip_user_files,runs,sim)		
			Vivado工程所需的各类文件
/MIPS_V1.0.srcs/sources_1/new	
			项目的核心代码
	testbranch.sv	在Nexys4实验板上测试的顶层模块
	clkdiv.sv		时钟分频模块模块，用于演示
	simulation.sv	仿真时使用的顶层模块
	top.sv			包含mips和两块内存的顶层模块
	mips.sv			mips处理的顶层模块
	dmem.sv			数据内存
	imem.sv			指令内存
	controller.sv	mips的控制单元，包含maindec和aludec两部分
	maindec.sv		主控单元，有总共11位的控制信号
	aludec.sv		alu控制单元，用于输出alucontrol信号
	datapath.sv		数据通路，mips的核心结构
	regfile.sv		寄存器文件
	alu.sb			alu计算单元
	adder.sv		加法器
	sl2.sv			左移2位
	mux2.sv			2:1复用器
	signextend.sv	符号拓展模块
	zeroextend.sv	零拓展模块
```

### 实验过程

因为我不是16级的学生，我首先需要学习的是Vivado的使用方法和System Verilog的语法。我花了2节课的时间阅读了教材的第四章和Vivado使用文档，并快速地在教材的第五章中找到ALU相关知识点，写好了我第一个System Verilog程序——ALU模块。我同时学会了利用仿真来测试模块的方法，测试出ALU模块在8种不同的输入下都能给出正确的输出。

随后我继续阅读了教材第六章的内容，了解了MIPS指令和他们对应的机器码。阅读了实验要求和<MIPS指令集.pdf>，在小本子上记下了要求的15个指令（我看错了，实际上只要求13个）的机器码结构，为下一步的设计打下了基础。其中我发现MIPS指令中nop指令实际上是sll指令的一个特例，所以我把nop指令和add，or等指令用同样的通路实现了。

在具体的代码实现上，我极大地参考了教材第七章的内容，具体实现的时候只增加了支持addi和ori的零扩展模块，并将maindec的controls拓展到11位。在这样的修改后，我可以轻松地实现这十几个mips指令。拓展之后的mips结构如下图：![单周期](imges\单周期.png)

在实现指令后，我利用PPT中介绍的QtSpim软件生成了若干测试用的汇编代码。如果执行这些代码能得到期望的结果，则说明我的代码有较大概率是正确的。当然，粗心的我还是犯了一些拼写错误，第一次仿真没有得到正确的结果；我一开始利用波形图的方式，查看各个寄存器的值，来查看自己的问题所在，波形图大致如下（大部分红色之中的绿色是寄存器的值）：

![波形图](C:\Users\will131\Documents\workspace\MIPS_V1.0\imges\波形图.png)

通过波形图的方法，我可以查看各个寄存器的值，验证自己程序的正确性。但我随后又发现了一种更高效的方法——利用verilog内置的\$display()函数，可以在Tcl Console 里面用打印出自己想要格式的变量值，并利用\$stop命令在验证完成后直接退出，大致效果如下：

![调试](imges\调试.png)

我编写了不同的.dat测试文件和其对应的仿真顶层模块，放在test文件夹下。测试时替换更目录下memfile.dat和源文件中的仿真顶层模块即可。经过多次不同的测试，我开始进行使用开发板进行测试。我的项目的资源占用和时钟情况如下：

![资源占用1](imges\资源占用1.png)

![资源占用2](imges\资源占用2.png)

![查看时钟](imges\查看时钟.png)

